services:
  app:
    image: ghcr.io/erykjuraszczyk-ui/agentcortana-app:${APP_TAG:-latest}
    profiles: ["app"]
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL_INTERNAL:-http://minio:9000}
      S3_BUCKET: ${S3_BUCKET}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_REGION: ${S3_REGION}
      OTEL_ENABLED: ${OTEL_ENABLED:-0}
      RATE_LIMIT: ${RATE_LIMIT:-60}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW:-60}
      RATE_LIMIT_PATHS: ${RATE_LIMIT_PATHS:-/act}
      TRUST_PROXY: ${TRUST_PROXY:-0}
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "${APP_PORT:-8081}:8000"

  watchtower:
    image: containrrr/watchtower:latest
    restart: unless-stopped
    command:
      - --label-enable
      - --cleanup
      - --interval=30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
